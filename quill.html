<!doctype html >
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link href="quill-style.css" rel="stylesheet">
</head>
<body>

<div class="container" style="padding: 0;">
    <form action="#" method="post" id="EntireForm">
        <div id="toolbar"  class="sticky-top" style="background-color:white;">
            <!-- Add font size dropdown -->
            <span class="ql-formats">
                <select class="ql-size">
                    <option value="0.56rem" style="font-size: 0.56rem;">-5단계</option>
                    <option value="0.583rem" style="font-size: 0.583rem;">-4단계</option>
                    <option value="0.668rem" style="font-size: 0.668rem;">-3단계</option>
                    <option value="0.75rem" style="font-size: 0.75rem;">-2단계</option>
                    <option value="0.833rem" style="font-size: 0.833rem;">-1단계</option>
                    <option selected style="font-size: 0.9rem;">기본</option>
                    <option value="1.16rem" style="font-size: 1.16rem;">+1단계</option>
                    <option value="1.25rem" style="font-size: 1.25rem;">+2단계</option>
                    <option value="1.332rem" style="font-size: 1.332rem;">+3단계</option>
                    <option value="1.417rem" style="font-size: 1.417rem;">+4단계</option>
                    <option value="1.5rem" style="font-size: 1.5rem;">+5단계</option>
                </select>
            </span>
            <!-- Add a bold button -->
            <span class="ql-formats">
                <button class="ql-bold"></button> 
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
                <button class="ql-strike"></button>
            </span>
            <!-- Add font color dropdown -->
            <span class="ql-formats">
                <select class="ql-color"></select>
                <select class="ql-background"></select>
            </span>
            <!-- Add subscript and superscript buttons -->
            <span class="ql-formats">
                <button class="ql-script" value="sub"></button>
                <button class="ql-script" value="super"></button>
            </span>
            <!-- Add text alignment dropdown -->
            <span class="ql-formats">
                <button class="ql-direction"></button>
                <select class="ql-align"></select>
            </span>
            <!-- Add image button -->
            <span class="ql-formats">
                <button class="ql-link" onclick="checkIfSelected()"></button>
                <button class="ql-image"></button>
                <button class="ql-video"></button>
            </span>
            <!-- Add code-block button -->
            <span class="ql-formats">
                <button class="ql-blockquote"></button>
                <button class="ql-code-block"></button>
            </span>
            <!-- Add clean button -->
            <span class="ql-formats">
                <button class="ql-clean"></button>
            </span>
        </div>
        <div class="form-group" id="FormBody">
            <!--This textarea will not be shown to user. (Quill adds bootstrap d-none class)-->
            <textarea id="QuillTextarea" name="input" class="quill-editor"></textarea>
        </div>
        <div class="text-right">
            <button type="button" class="btn btn-primary" onclick="makeMarkdown()">확인</button>
        </div>
    </form>
</div>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="quill-config.js"></script>
<script>
//시작함수
function makeMarkdown(){
    //p태그 배열로 나눈 후 각각의 p태그는 재귀함수로 감.
    var ptags = $(".ql-editor").first().contents();
    ptags.each(function(index){
        //혹시라도 p가 아닐지 모르니까 체크
        if(this.nodeType === 1 && $(this).prop("tagName")==="P"){ 
            eachTagToMarkdown(this);
            console.log("\n");
        }
    });
}
//재귀함수
function eachTagToMarkdown(elmt){
    $(elmt).contents().each(function(index){
        if(this.nodeType === 3){
            //텍스트 노드인 경우 출력
            console.log(this);
        } else if (this.nodeType=== 1){
            //태그인 경우 어떤 태그인지에 따라 결정.
            if($(this).prop("tagName")==="SPAN"){
                spanToMarkdown(this);
            }
            if($(this).prop("tagName")==="A"){
                var regexurl = /(https?:\/\/)?namu.wiki\/w\/.*/
                if(regexurl.test(this.href)){
                    //나무위키 문서 링크일 경우 문서명만 마크다운으로 출력.
                    var child = $(this).contents().first();
                    if(child.nodeType === 1){
                        //이미지일 경우

                        //사이즈나 색상 변형이 된 텍스트일 경우
                    }
                    if(child.nodeType === 3){
                        //텍스트일 경우
                        //텍스트와 링크된 문서명이 같은 경우
                        console.log("[[");
                        console.log(url.slice("namu.wiki/w/",-1));
                        console.log("]]");
                    }
                }
            }
        }
    });
}

function spanToMarkdown(elmt){
    console.log("{{{");
    console.log($(elmt).css("font-size"));
    
    switch($(elmt).css("font-size")){
        case "0.56rem": console.log("-5 "); break;
        case "0.583rem": console.log("-4 "); break;
        case "0.668rem": console.log("-3 "); break;
        case "0.75rem": console.log("-2 "); break;
        case "0.833rem": console.log("-1 "); break;
        case "1.16rem": console.log("+1 "); break;
        case "1.25rem": console.log("+2 "); break;
        case "1.332rem": console.log("+3 "); break;
        case "1.417rem": console.log("+4 "); break;
        case "1.5rem": console.log("+5 "); break;
    }
    eachTagToMarkdown(elmt);
    console.log("}}}");
}

function checkIfSelected(){
    if(document.getSelection().toString()==""){
        alert("먼저 텍스트나 이미지를 드래그하고 눌러주세요");
    }
}
</script>
</body>
</html>